# Monte Carlo Path Tracing



## 开发环境

- Win10 64位 
- 处理器 Intel(R) Core(TM) i5-8265 CPU @ 1.6GHz 1.80GHz 内存 8G
- IDE Microsoft Visual Studio 2017 Release x86
- 编码语言：C++
- 3rd party：
  - OpenGL ：用户界面
  - glm：三维数据存储计算
  - tinyObj：导入.obj和.mtl文件
  - FreeImage：以.png格式导出绘制的图片

## 文件结构

### scr（源码）

- .vs：配置文件

- Release：中间生成文件

- MCPT：源码文件夹

  ​		  --data：存放文本格式的计算结果，用于“离线”绘制

  ​		  --model：存放模型文件夹

  ​		  --result：绘制的结果，每次采样都会保存一份.png格式文件

  ​		  --tinyobjloader：obj文件导入插件

### MCPT（可执行二进制文件）

- data：存放文本格式的计算结果，用于“离线”绘制
- model：存放模型文件夹
- result：绘制的结果，每次采样都会保存一份.png格式文件

- MCPT.exe：生成的可执行二进制文件，打开后默认执行cbox模型，图片结果保存在当前路径下的./results/cbox/中，数据文本保存在当前路径下./data/cbox/下


### image

- 存放README.md所需引用图片资源

### Technical Report

- Report on rendering techniques



## 程序说明

作业文件夹中包含MCPT.exe可执行文件，双击可以读取默认默认模型（./model/cbox.obj）并且开始绘制,或者在VS2017中打开解决方案MCPT.sln,需配置为Release版 32位。

默认ssp=100,控制台窗口输出模型的各项信息，以及逐行输出每一次采样时间。可视化界面和控制台窗口分别如图1和图2：

<img src="C:\Users\PAN\Desktop\CG_21921218_潘小鹍\image\cbox.bmp" alt="cbox" style="zoom: 50%;" />

<img src="C:\Users\PAN\Desktop\CG_21921218_潘小鹍\image\consloe.bmp" alt="consloe" style="zoom:50%;" />

可以通过用vs2017修改源码中main函数中的绘制场景（Objname_render()）的调用来查看不同模型绘制效果。



## 数据结构说明

- AABB类：用于Triangle和Model和射线相交时的快速检测
- Material类：存储mtl中的各材料属性
- Triangel类：三角面片，碰撞检测的最小单元，包含顶点索引和法线索引
- Model类：读取obj文件，存储顶点、法向量的信息，将面片三角化，找出光源。
- Light类：场景中的光源，模拟直接光照，在模型光源较多时通过手动设置光源替代，可以加快绘制效率
- KdTree类：将面片元素以层次状数据结构存储，加速求交
- Camera类：设置相机的位置、朝向，视场等
- Ray类：设置光线的起点、方向、类型（反射、折射还是散射）和三角面片的交点记录等
- MonteCailoPathTracer类：路径追踪器，模拟光线在场景中的反射折射等物理行为，对每个像素点都要进行追踪
- Engine类：模拟绘制引擎，将Model、Camera、Light和MonteCailoPathTracer等类进行进一步封装，同时添加了可视化、结果存储，中间数据存储等功能。



## 实验结果

对每个场景默认采样100次，每次采样后将之前的采样结果进行平均处理，消除噪点。可以得到如下结果

### cobx

<img src="C:\Users\PAN\Desktop\CG_21921218_潘小鹍\image\001_cbox.png" alt="001_cbox" style="zoom:50%;" />

- 从左往右，从上往下的spp分别为1、10、50、100次，可以看出，在一次采样的结果，噪点很多，但随着采样次数的增多，噪点逐渐减少，在经过10次采样后，噪点大幅度减少，但仍可以看出，但当采样次数到达50次、100次时，绘制结果已经收敛到比较好的效果，真实感越来越强。
- 此模型的自身有两个三角形光源，但只用这两个光源的话，场景的亮度偏低偏暗，故在此基础上又添加了外部光源。
- 绘制结果和groundtruth相比，透明物体的绘制效果明显较差，整体偏暗，可能是和处理折射模型的时候有地方没有注意到
- 在曲面物体表面，有块状呈现明显的黑色（如水壶的表面）,初步判定是面片法向量计算错误导致散射模型没有处理好，但通过调试之后排除了这一原因，故这个也没有得到很好的处理
- 此模型在本机上采样一次大约1.1s左右。

### diningroom

<img src="C:\Users\PAN\Desktop\CG_21921218_潘小鹍\image\001_diningroom.png" alt="001_diningroom" style="zoom: 50%;" />

- 从上到下的采样次数分别为1、10、50和100，可以得出cbox中相同的结论
- 此模型的内置光源有1520个，而图像分辨率为1280X720，所以对于直接光照的计算占了总耗时的很大一部分，如果直接使用内置光源，在本机上的一次采样耗时大约一个小时，故为了提高整体的绘制效率，而没有使用内置的光源，而是手动添加了类似的光源，最终达到如图效果
- 对比groundtruth，整体光照不均匀的现象还是存在，比如灯罩上方的亮度
- 最终的一次采样耗时12s左右

### mis

<img src="C:\Users\PAN\Desktop\CG_21921218_潘小鹍\image\001_mis.png" alt="001_mis" style="zoom: 50%;" />

- 从左往右，从上往下的spp分别为1、10、50、100次，可以得出cbox中相同的结论
- 此模型没有手动添加外部的光源，内置光源数量3800个，故一次采样耗时本机上大约10min左右
- 此模型与groundtruth比较，有几个明显的问题：环境物体的颜色失真,反光物质的颜色明显不对，灯光背景存在光晕等，没有很好的处理好。但目前问题的定位依旧在反射散射模型上。
- 最终的一次采样耗时10min左右

### CornellBox-Glossy（自定义场景）

<img src="C:\Users\PAN\Desktop\CG_21921218_潘小鹍\image\010_CornellBox-Glossy.png" alt="010_CornellBox-Glossy" style="zoom:50%;" />

- 由于场景较为简单，一次采样耗时大约0.4s



## 补充说明

- 由于光线跟踪需要对绘制图像中的每个像素点进行采样，总的采样次数和光源数量、图像分辨率等参数相关，故对于高分辨率、光源数量较多的场景（如diningroom），需要进行相应的加速处理：

  - 采用手动添加的光照而没有使用内置的光源，可以极大提高光源数量较多的场景的绘制效率

  - 利用OpenMP来进行对像素点之间采样的并行计算，可以极大的提升计算效率，经实验本机上大概会同时运行10个线程来进行像素点的并行计算
  - 对于光线追踪的底层计算，需要采用比较高效的算法，比如采用kd树等层级结构加速求交。以及印象比较深的将fmax换为max求两数中较大值可以将一次采样结果缩短为1/4，所以对于一些可以通过优化程序的结构或者计算流程提高效率
- 同时，由于在家计算资源紧缺，为了避免在连续多次采样过程中，因意外情况程序中断，故在实验过程中，将每单次采样结果（即每个像素点的三色）以文本形式保存。当采样spp达到了设定数值时，再重新读取记录文件，进行“离线”绘制。同样可以得到在不同采样次数下的绘制结果（源码中主函数的offline_render()）。
- 为了使得最终的绘制的效果更好，对于obj文件和mtl文件中的一些参数以及相机参数的设定进行了略微的调整。例如对于自己定义的场景在一开始导入时会出现一下情形

<img src="C:\Users\PAN\Desktop\CG_21921218_潘小鹍\image\capture_20200319211943006.bmp" alt="capture_20200319211943006" style="zoom:50%;" />

​		一开始以为是法向量或者三角化面片出现了问题，排除了很多可能的原因，后来发现将floor的四个顶点的y方向坐标由0.0000改为0.0001此问题就消失了。所以可以断定程序在处理浮点数的时候存在一定的误差。